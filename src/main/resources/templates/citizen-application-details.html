<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Application Details | CSP</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body { background: linear-gradient(to right,#eef2f7,#f8fafc); font-family:'Segoe UI'; }
        .details-card { border-radius:16px; border:none; }
        .status-badge { font-size:0.9rem; padding:8px 14px; }

        /* Progress */
        .progress-steps { display:flex; justify-content:space-between; margin:35px 0; position:relative; }
        .progress-steps::before { content:""; position:absolute; top:18px; left:0; right:0; height:4px; background:#dbeafe; z-index:0; border-radius:10px; }
        .step { text-align:center; position:relative; z-index:1; width:33%; }
        .step-circle { width:38px; height:38px; border-radius:50%; background:#cbd5e1; margin:auto; line-height:38px; font-weight:bold; color:white; }
        .step.active .step-circle { background:#16a34a; box-shadow:0 0 10px rgba(22,163,74,0.6); }

        /* Timeline */
        .timeline { position:relative; list-style:none; padding-left:0; }
        .timeline::before { content:''; position:absolute; left:20px; top:0; bottom:0; width:4px; background:linear-gradient(#0d6efd,#6366f1); }
        .timeline-item { position:relative; margin-bottom:30px; padding-left:65px; }
        .timeline-item::before { content:''; position:absolute; left:12px; top:8px; width:18px; height:18px; border-radius:50%; background:white; border:4px solid #0d6efd; }
        .timeline-content { background:white; padding:14px 18px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.08); }
    </style>
</head>

<body>
<div class="container my-5">

    <div class="text-center mb-4">
        <h2 class="fw-bold"><i class="bi bi-file-earmark-text"></i> Application Details</h2>
        <p class="text-muted">Track the complete progress of your service request</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-9">

            <!-- ================= PROGRESS ================= -->
            <div class="progress-steps">
                <div class="step" th:classappend="${app.status != null} ? 'active'">
                    <div class="step-circle">1</div>
                    <div>Submitted</div>
                </div>
                <div class="step" th:classappend="${app.status == 'VERIFIED' or app.status == 'APPROVED'} ? 'active'">
                    <div class="step-circle">2</div>
                    <div>Verified</div>
                </div>
                <div class="step" th:classappend="${app.status == 'APPROVED'} ? 'active'">
                    <div class="step-circle">3</div>
                    <div>Approved</div>
                </div>
            </div>

            <!-- ================= INFO CARD ================= -->
            <div class="card shadow-sm details-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Application Information</h5>
                </div>

                <div class="card-body">
                    <table class="table table-bordered align-middle">
                        <tbody>
                        <tr><th width="40%">Application ID</th><td th:text="${app.applicationId}"></td></tr>
                        <tr><th>Service Type</th><td th:text="${app.serviceType}"></td></tr>
                        <tr><th>Applied On</th><td th:text="${#temporals.format(app.applicationDate,'dd-MM-yyyy HH:mm')}"></td></tr>
                        <tr>
                            <th>Status</th>
                            <td>
                                <span th:if="${app.status=='SUBMITTED'}" class="badge bg-warning text-dark status-badge">Submitted</span>
                                <span th:if="${app.status=='VERIFIED'}" class="badge bg-info text-dark status-badge">Verified</span>
                                <span th:if="${app.status=='APPROVED'}" class="badge bg-success status-badge">Approved</span>
                                <span th:if="${app.status.startsWith('REJECTED')}" class="badge bg-danger status-badge">Rejected</span>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <!-- Certificate -->
                    <div class="text-center mt-3" th:if="${app.status=='APPROVED'}">
                        <a th:href="@{/certificate/download/{id}(id=${app.applicationId})}" class="btn btn-success">
                            <i class="bi bi-download"></i> Download Certificate
                        </a>
                    </div>
                </div>
            </div>

            <!-- ================= REJECTION BOX ================= -->
            <div class="card border-danger mt-4" th:if="${app.status.startsWith('REJECTED')}">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-x-circle"></i> Application Rejected
                </div>
                <div class="card-body">
                    <p><b>Rejected By:</b> <span th:text="${app.rejectedBy}"></span></p>
                    <p><b>Reason:</b></p>
                    <div class="alert alert-danger" th:text="${app.rejectionReason}"></div>
                </div>
            </div>

            <!-- ================= TIMELINE ================= -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Status Timeline</h5>
                </div>

                <div class="card-body">
                    <ul class="timeline">
                        <li class="timeline-item" th:each="h : ${history}">
                            <div class="timeline-content">
                                <h6 class="fw-bold mb-1" th:text="${h.newStatus}"></h6>
                                <p class="mb-1 text-muted">
                                    From <b th:text="${h.oldStatus}"></b> → <b th:text="${h.newStatus}"></b>
                                </p>
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i>
                                    <span th:text="${#temporals.format(h.changedAt,'dd-MM-yyyy HH:mm')}"></span>
                                    by <b th:text="${h.changedByRole}"></b> (<span th:text="${h.changedBy}"></span>)
                                </small>
                            </div>
                        </li>
                        <li th:if="${#lists.isEmpty(history)}" class="text-center text-muted">
                            No status updates yet
                        </li>
                    </ul>
                </div>
            </div>

            <div class="text-center mt-4">
                <a th:href="@{/citizen/dashboard}" class="btn btn-outline-primary">
                    ← Back to Dashboard
                </a>
            </div>

        </div>
    </div>
</div>
</body>
</html>
